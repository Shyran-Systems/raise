#!/usr/bin/env groovy
@Library('utils') _

pipeline {

  agent {
    docker {
      image "node:11"
    }
  }

  stages {
    
    stage('PREPARE'){
      steps{
        nodejs(nodeJSInstallationName: 'node_11') {
          sh 'echo "- INSTALL NODE_MODULES"'
          sh 'npm i'
        }
      }
    }

    /*
      NOT FOR NOW
      stage('TEST') {
      when {
        expression { env.BRANCH_NAME != 'master' }
      }
      steps {
        nodejs(nodeJSInstallationName: 'node_11') {
          sh 'echo "- TEST"'
          //sh 'npm run test'
        }
      }
      post {
        always {
          junit "output/coverage/junit/junit.xml"
          publishHTML target: [
            allowMissing         : false,
            alwaysLinkToLastBuild: false,
            keepAll              : true,
            reportDir            : 'output/coverage/jest/lcov-report',
            reportFiles          : 'index.html',
            reportName           : 'Test Report'
          ]
        }
      }
    }*/

    stage('BUILD'){  
       
      steps {
         sh 'npm run ${BUILD_SH}'
      }
    }
    stage('CLEAN BUCKET') { 
      steps {
        withAWS(credentials: env.AWSUSER) {
          //Clean all Bucket
          s3Delete(bucket: env.BUCKETNAME, path: "/")
        }  
      }
    }
    stage('UPLOAD BUCKET') { 
      steps {
        withAWS(credentials: env.AWSUSER) {
          //Upload Files to root path
          s3Upload(bucket: env.BUCKETNAME, file: env.BUILD_PATH)
        }
      }  
    }
  }

  environment {
    AWSUSER = 'aws_cred_id'
    BUILD_PATH = './build'
    BUCKETNAME = utils.getS3Bucket()
    BUILD_SH   = utils.buildByEnv()
  }
  
  options {
    disableConcurrentBuilds()
  }
  
  post {
    failure { script{ utils.nFailure() } }
    fixed { script { utils.nFixed() } }
    unstable { script { utils.nUnstable() } }
    success { script { utils.nSuccess() } }
    cleanup { script{ cleanWs() } }
  }
}
